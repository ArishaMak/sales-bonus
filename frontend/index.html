<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https:;
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.tailwindcss.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://r2cdn.perplexity.ai data:;
        img-src 'self' data: blob: https:;
        connect-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://api.example.com;
      ">
    <title>Анализ продаж магазина</title>
    <link rel="stylesheet" href="./css/fonts.css" />
    <link rel="stylesheet" href="./css/globals.css" />
    <link rel="stylesheet" href="./css/variables.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/dark.css" />
    <link rel="stylesheet" href="./css/light.css" />
    <!-- Chart.js CDN в head -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="page">
    <!-- Layout -->
    <div class="page-layout">
        <!-- Хедер -->
        <header class="header">
            <div class="wrapper flexbox middle">
                <a href="/" class="logotype">
                    <img src="../images/logo.png" alt="Logo" class="logotype__img">
                    <span>ShopAnalytics</span>
                </a>
                <nav class="menu">
                    <a id="dashboardBtn" href="javascript:void(0)">Дашборд</a>
                    <a href="#reports" onclick="showPage('reports-page')">Отчёты</a>
                    <a href="#settings" onclick="showPage('settings-page')">Настройки</a>
                </nav>
                <div class="header-actions flexbox" style="gap: 1em;">
                    <button id="loginBtn" class="btn btn-secondary">Войти</button>
                    <button id="registerBtn" class="btn btn-primary">Регистрация</button>
                </div>
                <button class="mobile-toggle" aria-label="Меню">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </header>
        <!-- Hero + Фильтры -->
        <main class="hero">
            <div class="cosmic-bg">
                <div class="stars"></div>
                <div class="stars2"></div>
                <div class="stars3"></div>
                <div class="background-planet"></div>
                <div class="mars-rings-front"></div>
                <div class="mars-rings"></div>
            </div>
            <div class="wrapper-hero">
                <div class="wrapper">
                    <div class="h_part">
                        <div class="h1_box h_part">
                            <h1 class="h1" data-text="Анализ продаж в реальном времени">
                                Анализ продаж в реальном времени
                            </h1>
                        </div>
                        <p class="header__paragraph" style="font-size: 1.6em; color: var(--gray); max-width: 50ch; margin: 1.5em 0;">
                            Аналитика выручки, бонусов и топ-продуктов по продавцам. Фильтруйте, ищите, экспортируйте.
                        </p>
                        <div>
                            <a href="#filters" class="btn btn-primary">Начать анализ</a>
                        </div>
                    </div>
                    <!-- Фильтры -->
                    <section id="filters" class="filters-panel">
                        <div class="filter-group">
                            <input type="text" id="search" placeholder="Поиск по продавцу или покупателю" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <select id="sellerFilter" class="filter-select"></select>
                        </div>
                        <div class="filter-group">
                            <select id="skuFilter" class="filter-select"></select>
                        </div>
                        <div class="filter-group">
                            <button id="applyFilters" class="btn btn-primary">Применить</button>
                            <button id="resetFilters" class="btn btn-secondary">Сброс</button>
                        </div>
                    </section>
                </div>
            </div>
            <!-- Результаты (анализ продавцов) -->
            <section id="results" class="results-section">
                <div class="wrapper">
                    <div class="section-header flexbox middle">
                        <h2>Результаты анализа</h2>
                        <div class="export-btn">
                            <button class="btn btn-secondary">Экспорт CSV</button>
                        </div>
                    </div>
                    <!-- Краткая сводка — с placeholders для дашборда -->
                    <div id="summary" class="summary-cards">
                        <div class="card">Продукты: <span id="totalProducts">0</span></div>
                        <div class="card">Записи: <span id="totalRecords">0</span></div>
                        <div class="card">Клиенты: <span id="totalCustomers">0</span></div>
                    </div>
                    <!-- Таблица -->
                    <div class="table-container">
                        <table id="reportTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Продавец</th>
                                    <th>Выручка</th>
                                    <th>Прибыль</th>
                                    <th>Продаж</th>
                                    <th>KPI</th>
                                    <th>Бонус</th>  
                                    <th>Топ-товары</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="sellerTableBody">
                                <!-- ... здесь вставляются строки из table.js ... -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination">
                        <!-- Пагинация генерируется JS -->
                    </div>
                    <!-- Топ-товары -->
                    <div id="topProductsSection">
                        <!-- Генерируется JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- Модалка продавца -->
    <div id="sellerCardModal" class="modal">
        <div class="modal-content">
            <div id="sellerCardContent">
                <!-- Рендерится JS -->
            </div>
        </div>
    </div>
    <!-- Модалка входа (Login Modal) -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вход</h3>
                <button class="close-button" id="closeLoginBtn">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Войти</button>
            </form>
            <div id="loginMessage" style="margin-top: 1em; color: red;"></div>
        </div>
    </div>
    <!-- Модалка регистрации -->
    <div id="registerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Регистрация</h3>
                <button class="close-button" id="closeRegisterModal">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password:</label>
                    <input type="password" id="regPassword" minlength="8" required>
                </div>
                <div class="form-group">
                    <label for="regName">Name:</label>
                    <input type="text" id="regName" required>
                </div>
                <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
            </form>
            <div id="regMessage" style="margin-top: 1em; color: green;"></div>
        </div>
    </div>
    <script type="module" src="./src/main.js"></script>
    <!-- JavaScript для управления модальными окнами -->
    <script type="module">
        // Импорт для логина
        import { loginUser } from "./src/modules/auth.js";

        // Глобальные функции (делаем их доступными для onclick, но используем addEventListener)
        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('role', 'dialog');
            }
        };

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.removeAttribute('aria-modal');
                modal.removeAttribute('role');
            }
        };

        // Заглушки
        window.showPage = function(pageId) {
            console.log(`Навигация к странице: ${pageId}`);
        };

        window.openSellerCard = function(sellerData) {
            console.log('Открытие карточки продавца:', sellerData);
            const content = document.getElementById('sellerCardContent');
            if (content) {
                content.innerHTML = `<p>Детали продавца ${sellerData.name} будут здесь.</p>`;
            }
            openModal('sellerCardModal');
        };

        // Обработчик кнопки "Дашборд"
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem("userId");
            const dashboardBtn = document.getElementById("dashboardBtn");
            if (dashboardBtn) {
                dashboardBtn.addEventListener("click", () => {
                    if (!userId) {
                        alert("Сначала войдите в аккаунт");
                        openModal('loginModal');
                        return;
                    }
                    window.location.href = "/dashboard.html";
                });
                // Скрыть кнопку, если не авторизован
                if (!userId) {
                    dashboardBtn.style.display = "none";
                }
            }

            // Обработчики кнопок "Войти" и "Регистрация" (замена onclick)
            const loginBtn = document.getElementById("loginBtn");
            const registerBtn = document.getElementById("registerBtn");
            if (loginBtn) loginBtn.addEventListener("click", () => openModal('loginModal'));
            if (registerBtn) registerBtn.addEventListener("click", () => openModal('registerModal'));

            // Закрытие модалок по крестику
            const closeLoginBtn = document.getElementById("closeLoginBtn");
            const closeRegisterBtn = document.getElementById("closeRegisterModal");
            if (closeLoginBtn) closeLoginBtn.addEventListener("click", () => closeModal('loginModal'));
            if (closeRegisterBtn) closeRegisterBtn.addEventListener("click", () => closeModal('registerModal'));

            // Закрытие по клику вне модалки
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === modal.id) {
                        closeModal(modal.id);
                    }
                });
            });

            // Обработчик формы логина
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.textContent = '';
                    loginMessage.style.color = '';

                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;

                    try {
                        const data = await loginUser({ email, password });
                        loginMessage.textContent = `Вход успешен! Добро пожаловать, ${data.name || email}!`;
                        loginMessage.style.color = 'green';
                        setTimeout(() => {
                            closeModal('loginModal');
                            loginForm.reset();
                            window.location.href = "/dashboard.html";
                        }, 1500);
                    } catch (error) {
                        loginMessage.textContent = error.message || 'Ошибка входа. Проверьте данные.';
                        loginMessage.style.color = 'red';
                        console.error('Login failed:', error);
                    }
                });
            }

            // Обработчик формы регистрации
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const regMessage = document.getElementById('regMessage');
                    regMessage.textContent = '';
                    regMessage.style.color = '';

                    const email = document.getElementById('regEmail').value;
                    const password = document.getElementById('regPassword').value;
                    const name = document.getElementById('regName').value;

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password, name }),
                        });
                        const data = await response.json();

                        if (response.ok) {
                            regMessage.textContent = `Регистрация успешна! Добро пожаловать, ${data.name || name}!`;
                            regMessage.style.color = 'green';
                            setTimeout(() => {
                                closeModal('registerModal');
                                registerForm.reset();
                                window.location.href = "/dashboard.html";
                            }, 1500);
                        } else {
                            const errorMessage = data.message || data.error || 'Ошибка регистрации. Попробуйте снова.';
                            regMessage.textContent = errorMessage;
                            regMessage.style.color = 'red';
                            console.error('Registration failed:', errorMessage);
                        }
                    } catch (error) {
                        regMessage.textContent = 'Ошибка сети. Проверьте соединение с сервером.';
                        regMessage.style.color = 'red';
                        console.error('Network or critical error:', error);
                    }
                });
            }
        });
    </script>
</body>
</html>